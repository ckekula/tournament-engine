pipeline {
    agent any
    
    parameters {
        string(name: 'FRONTEND_TAG', defaultValue: 'latest', description: 'Frontend Docker image tag')
        string(name: 'BACKEND_TAG', defaultValue: 'latest', description: 'Backend Docker image tag')
    }
    
    stages {
        stage('Deploy') {
            steps {
                sh '''
                    export DOCKERHUB_USERNAME="${DOCKERHUB_USERNAME}"
                    export FRONTEND_TAG=${params.FRONTEND_TAG}
                    export BACKEND_TAG=${params.BACKEND_TAG}
                    
                    cd /home/ubuntu
                    docker-compose -f deploy-compose.yml down || true
                    docker-compose -f deploy-compose.yml up -d
                '''
            }
        }
        
        stage('Verify') {
            steps {
                sh 'sleep 30'  // Give services time to start
                sh 'curl -f http://localhost:80 || exit 1'  // Check frontend
                sh 'curl -f http://localhost:4000/health || exit 1'  // Check backend health endpoint
            }
        }
    }
}