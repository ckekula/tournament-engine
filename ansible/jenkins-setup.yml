---
- name: Setup Jenkins in Docker
  hosts: localhost
  become: yes
  vars:
    jenkins_admin_password: admin # use vault for production
    jenkins_home: /var/jenkins_home
    docker_compose_version: "2.22.0"
    github_sha: "{{ lookup('env', 'GITHUB_SHA') | default('latest', true) }}"
    dockerhub_username: "{{ lookup('env', 'DOCKERHUB_USERNAME') }}"

  tasks:
    - name: Install required packages
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - python3-pip
          - jq
        state: present
        update_cache: yes

    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker repository
      apt_repository:
        repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable
        state: present

    - name: Install Docker
      apt:
        name: docker-ce
        state: present
        update_cache: yes

    - name: Ensure Docker service is running
      service:
        name: docker
        state: started
        enabled: yes

    - name: Install Docker Compose
      get_url:
        url: "https://github.com/docker/compose/releases/download/v{{ docker_compose_version }}/docker-compose-linux-x86_64"
        dest: /usr/local/bin/docker-compose
        mode: "0755"

    - name: Add ubuntu user to docker group
      user:
        name: ubuntu
        groups: docker
        append: yes

    - name: Create Jenkins directories
      file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      with_items:
        - /var/jenkins_home
        - /var/jenkins_home/casc_configs
        - /var/jenkins_home/jobs
        - /var/jenkins_home/jobs/deploy
        - /var/jenkins_home/jobs/deploy/workspace

    - name: Copy Jenkins Docker Compose file
      copy:
        src: /home/ubuntu/ansible/files/docker-compose.yml
        dest: /home/ubuntu/docker-compose.yml
        remote_src: yes # file is already on the remote host

    - name: Copy deployment docker-compose file
      copy:
        src: /home/ubuntu/ansible/files/deploy-compose.yml
        dest: /home/ubuntu/deploy-compose.yml
        remote_src: yes

    - name: Copy job config XML
      copy:
        src: files/config.xml
        dest: /var/jenkins_home/jobs/deploy/config.xml
        remote_src: yes
        owner: jenkins
        group: jenkins
        mode: "0644"

    - name: Reload Jenkins configuration
      command: docker exec jenkins curl -X POST http://localhost:8080/reload -u admin:admin

    - name: Copy Jenkins configuration
      copy:
        src: /home/ubuntu/ansible/files/jenkins.yaml
        dest: /home/ubuntu/jenkins_config/jenkins.yaml
        remote_src: yes

    - name: Start Jenkins container
      command: docker-compose up -d
      args:
        chdir: /home/ubuntu

    - name: Wait for Jenkins to start
      wait_for:
        port: 8080
        delay: 10
        timeout: 300

    # Install plugins FIRST before configuring jobs
    - name: Install Jenkins plugins
      command: >
        docker exec jenkins curl -s -X POST 
        -u admin:admin 
        --data-urlencode "script=
        import jenkins.model.*
        import java.util.logging.Logger
        def instance = Jenkins.getInstance()
        def pm = instance.getPluginManager()
        def uc = instance.getUpdateCenter()
        def plugins = [
          'workflow-aggregator',
          'git',
          'docker-workflow',
          'pipeline-stage-view',
          'configuration-as-code',
          'job-dsl'
        ]
        plugins.each { plugin ->
          if (!pm.getPlugin(plugin)) {
            def plugin = uc.getPlugin(plugin)
            if (plugin) {
              plugin.deploy()
              logger.info('Installing ' + plugin.getDisplayName())
            }
          }
        }
        instance.save()
        " http://localhost:8080/scriptText
      register: plugin_install
      retries: 3
      delay: 15
      until: plugin_install.rc == 0

    # Configure JCasC AFTER plugins are installed
    - name: Copy Jenkins configuration
      copy:
        src: /home/ubuntu/ansible/files/jenkins.yaml
        dest: /var/jenkins_home/jenkins.yaml
        remote_src: yes
        owner: jenkins
        group: jenkins
        mode: "0644"

    - name: Apply JCasC configuration
      command: docker restart jenkins
      async: 10
      poll: 0

    - name: Wait for Jenkins after restart
      wait_for:
        port: 8080
        delay: 10
        timeout: 60
      register: jenkins_ready
      until: jenkins_ready is success
      retries: 5
      delay: 10

    # Now setup the job
    - name: Ensure Jenkins jobs directory exists
      file:
        path: /var/jenkins_home/jobs/deploy
        state: directory
        owner: jenkins
        group: jenkins
        mode: "0755"

    - name: Copy job config XML
      copy:
        src: /home/ubuntu/ansible/files/config.xml
        dest: /var/jenkins_home/jobs/deploy/config.xml
        remote_src: yes
        owner: jenkins
        group: jenkins
        mode: "0644"

    # Final reload and verification
    - name: Reload Jenkins configuration
      command: docker exec jenkins curl -X POST http://localhost:8080/reload -u admin:admin
      register: reload_result
      retries: 3
      delay: 10
      until: reload_result.rc == 0

    - name: Verify job exists
      uri:
        url: http://localhost:8080/job/deploy/api/json
        user: admin
        password: admin
        status_code: 200
        validate_certs: no
      register: job_check
      retries: 5
      delay: 10
      until: job_check.status == 200

    - name: Copy production SSH key
      copy:
        content: "{{ lookup('env', 'PRODUCTION_SSH_KEY') }}"
        dest: /var/jenkins_home/production-key.pem
        mode: "0600"
        owner: jenkins
        group: jenkins
