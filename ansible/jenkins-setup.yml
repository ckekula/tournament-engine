---
- name: Setup Jenkins in Docker
  hosts: localhost
  become: yes
  vars:
    jenkins_admin_password: admin # use vault for production
    jenkins_home: /var/jenkins_home
    docker_compose_version: "2.22.0"
    github_sha: "{{ lookup('env', 'GITHUB_SHA') | default('latest', true) }}"
    dockerhub_username: "{{ lookup('env', 'DOCKERHUB_USERNAME') }}"

  tasks:
    - name: Install required packages
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - python3-pip
          - jq
        state: present
        update_cache: yes

    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker repository
      apt_repository:
        repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable
        state: present

    - name: Install Docker
      apt:
        name: docker-ce
        state: present
        update_cache: yes

    - name: Ensure Docker service is running
      service:
        name: docker
        state: started
        enabled: yes

    - name: Install Docker Compose
      get_url:
        url: "https://github.com/docker/compose/releases/download/v{{ docker_compose_version }}/docker-compose-linux-x86_64"
        dest: /usr/local/bin/docker-compose
        mode: "0755"

    - name: Add ubuntu user to docker group
      user:
        name: ubuntu
        groups: docker
        append: yes

    - name: Create Jenkins directories
      file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      with_items:
        - /var/jenkins_home
        - /var/jenkins_home/casc_configs
        - /home/ubuntu/jenkins_config

    - name: Copy Jenkins Docker Compose file
      copy:
        src: /home/ubuntu/ansible/files/docker-compose.yml
        dest: /home/ubuntu/docker-compose.yml
        remote_src: yes # This tells Ansible the file is already on the remote host

    - name: Copy deployment docker-compose file
      copy:
        src: /home/ubuntu/ansible/files/deploy-compose.yml
        dest: /home/ubuntu/deploy-compose.yml
        remote_src: yes

    - name: Copy Jenkinsfile
      copy:
        src: /home/ubuntu/ansible/files/Jenkinsfile
        dest: /home/ubuntu/Jenkinsfile
        remote_src: yes

    - name: Copy Jenkins configuration
      copy:
        src: /home/ubuntu/ansible/files/jenkins.yaml
        dest: /home/ubuntu/jenkins_config/jenkins.yaml
        remote_src: yes

    - name: Start Jenkins container
      command: docker-compose up -d
      args:
        chdir: /home/ubuntu

    - name: Wait for Jenkins to start
      wait_for:
        port: 8080
        delay: 10
        timeout: 300

    - name: Install Jenkins plugins
      command: >
        docker exec jenkins curl -s -X POST 
        -u admin:admin 
        --data-urlencode "script=
        import jenkins.model.*
        import java.util.logging.Logger
        def instance = Jenkins.getInstance()
        def pm = instance.getPluginManager()
        def uc = instance.getUpdateCenter()
        def plugins = [
          'workflow-aggregator',
          'git',
          'docker-workflow',
          'pipeline-stage-view',
          'configuration-as-code',
          'job-dsl'
        ]
        plugins.each { plugin ->
          if (!pm.getPlugin(plugin)) {
            def plugin = uc.getPlugin(plugin)
            if (plugin) {
              plugin.deploy()
              logger.info('Installing ' + plugin.getDisplayName())
            }
          }
        }
        instance.save()
        " http://localhost:8080/scriptText

    - name: Wait for plugins to install
      pause:
        seconds: 10

    - name: Create deploy job using Jenkins Script Console
      command: >
        docker exec jenkins curl -s -X POST
        -u admin:admin
        --data-urlencode "script=
        import jenkins.model.Jenkins
        import org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition
        import org.jenkinsci.plugins.workflow.job.WorkflowJob
        import hudson.model.StringParameterDefinition
        import hudson.model.ParametersDefinitionProperty

        // Get Jenkins instance
        def jenkins = Jenkins.getInstance()

        // Create the job if it doesn't exist, otherwise update it
        def job = jenkins.getItem('deploy')
        if (job == null) {
            job = jenkins.createProject(WorkflowJob.class, 'deploy')
        }

        // Add job parameters
        def paramsList = new ArrayList<StringParameterDefinition>()
        paramsList.add(new StringParameterDefinition('FRONTEND_TAG', 'latest', 'Frontend Docker image tag'))
        paramsList.add(new StringParameterDefinition('BACKEND_TAG', 'latest', 'Backend Docker image tag'))
        paramsList.add(new StringParameterDefinition('PRODUCTION_IP', '', 'Production server IP address'))
        def params = new ParametersDefinitionProperty(paramsList)
        job.addProperty(params)

        // Read Jenkinsfile content (mounted from the host)
        def jenkinsfile = new File('/var/jenkins_home/Jenkinsfile')
        if (!jenkinsfile.exists()) {
            // Create a simple placeholder Jenkinsfile if it doesn't exist
            jenkinsfile = new File('/tmp/Jenkinsfile')
            jenkinsfile.text = '''
            pipeline {
              agent any
              
              parameters {
                  string(name: 'FRONTEND_TAG', defaultValue: 'latest', description: 'Frontend Docker image tag')
                  string(name: 'BACKEND_TAG', defaultValue: 'latest', description: 'Backend Docker image tag')
              }
              
              stages {
                  stage('Deploy') {
                      steps {
                          // Copy deployment files to production server
                          sh '''
                              scp -o StrictHostKeyChecking=no -i /var/jenkins_home/production-key.pem /home/ubuntu/deploy-compose.yml ubuntu@${params.PRODUCTION_IP}:/home/ubuntu/
                              
                              # SSH to production and deploy
                              ssh -o StrictHostKeyChecking=no -i /var/jenkins_home/production-key.pem ubuntu@${params.PRODUCTION_IP} "
                                  export DOCKERHUB_USERNAME=${DOCKERHUB_USERNAME}
                                  export FRONTEND_TAG=${params.FRONTEND_TAG}
                                  export BACKEND_TAG=${params.BACKEND_TAG}
                                  
                                  # Ensure docker is installed on production
                                  if ! command -v docker &> /dev/null; then
                                      sudo apt update
                                      sudo apt install -y docker.io docker-compose
                                      sudo usermod -aG docker ubuntu
                                  fi
                                  
                                  # Deploy the application
                                  sudo docker-compose -f deploy-compose.yml down || true
                                  sudo docker-compose -f deploy-compose.yml up -d
                              "
                          '''
                      }
                  }
                  
                  stage('Verify') {
                      steps {
                          sh '''
                              sleep 30  # Give services time to start
                              curl -f http://${params.PRODUCTION_IP} || exit 1  # Check frontend
                              curl -f http://${params.PRODUCTION_IP}:4000/health || exit 1  # Check backend health endpoint
                          '''
                      }
                  }
              }
          }
            '''
        }

        // Set the job definition
        def flowDefinition = new CpsFlowDefinition(jenkinsfile.text, true)
        job.setDefinition(flowDefinition)
        job.save()

        return 'Job created/updated successfully'
        " http://localhost:8080/scriptText

    - name: Copy Jenkinsfile to Jenkins container
      command: docker cp /home/ubuntu/Jenkinsfile jenkins:/var/jenkins_home/Jenkinsfile

    - name: Update job with actual Jenkinsfile
      command: >
        docker exec jenkins curl -s -X POST
        -u admin:admin
        --data-urlencode "script=
        import jenkins.model.Jenkins
        import org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition

        // Get Jenkins instance
        def jenkins = Jenkins.getInstance()

        // Get the job
        def job = jenkins.getItem('deploy')

        // Read Jenkinsfile content
        def jenkinsfile = new File('/var/jenkins_home/Jenkinsfile')

        // Update the job definition
        def flowDefinition = new CpsFlowDefinition(jenkinsfile.text, true)
        job.setDefinition(flowDefinition)
        job.save()

        return 'Job updated with actual Jenkinsfile'
        " http://localhost:8080/scriptText

    - name: Restart Jenkins to apply JCasC
      command: docker restart jenkins
      async: 10
      poll: 0

    - name: Wait for Jenkins to be reachable after restart
      wait_for:
        port: 8080
        delay: 10
        timeout: 30 # Wait 30 seconds
      register: jenkins_ready
      until: jenkins_ready is success
      retries: 3
      delay: 10

    - name: Copy production SSH key
      copy:
        content: "{{ lookup('env', 'PRODUCTION_SSH_KEY') }}"
        dest: /var/jenkins_home/production-key.pem
        mode: "0600"
        owner: root
        group: root
